<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Login with Face Recognition</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 2rem;
    }
    video {
      width: 320px;
      height: auto;
      border-radius: 10px;
      margin-bottom: 1rem;
    }
    #empIdGroup {
      display: none;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <h2>Face Recognition Login</h2>
  <video id="video" autoplay playsinline></video>

  <div id="empIdGroup">
    <input type="text" id="empId" placeholder="Enter Employee ID (if face not detected)">
  </div>

  <p id="status"></p>
  <script>
    const video = document.getElementById('video');
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const empIdInput = document.getElementById('empId');
    const statusText = document.getElementById('status');

    let hasLoggedIn = false;
    let fallbackShown = false;

    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
        video.srcObject = stream;
        })
        .catch(err => {
        statusText.textContent = 'Camera access denied.';
        });

    async function punchInAndRedirect() {
        navigator.geolocation.getCurrentPosition(async (position) => {
        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;

        const response = await fetch('/punchin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ latitude, longitude })
        });

        const result = await response.json();
        if (result.status === 'success') {
            window.location.href = '/dashboard';
        } else {
            statusText.textContent = 'Punch-in failed: ' + (result.error || '');
        }
        }, () => {
        statusText.textContent = 'Geolocation failed.';
        });
    }

    async function tryLoginWithFace() {
        if (hasLoggedIn || video.readyState !== 4) return;

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = canvas.toDataURL('image/png');

        const response = await fetch('/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            empId: empIdInput.value,
            image: imageData
        })
        });

        const data = await response.json();

        if (data.redirect && !hasLoggedIn) {
        hasLoggedIn = true;
        statusText.textContent = "Login successful. Punching in...";
        await punchInAndRedirect();
        } else if (data.error) {
        statusText.textContent = data.error;
        }

    // Show fallback ID after 30 seconds if login fails
        if (!fallbackShown) {
        setTimeout(() => {
            empIdInput.style.display = 'block';
            fallbackShown = true;
        }, 30000);
        }
    }

    setInterval(tryLoginWithFace, 1000);
    </script>

  </body>
</html>
